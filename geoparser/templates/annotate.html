<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Annotate Document</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <!-- Custom CSS -->
    <style>
        /* Toponym styles */
        .toponym {
            background-color: #f1948a;
            cursor: pointer;
        }
        .toponym.annotated {
            background-color: #85c1e9;
        }
        /* Progress bar styles */
        .progress {
            height: 10px;
            margin-top: 5px;
        }
        /* Candidate list */
        .candidate {
            margin-bottom: 5px;
            cursor: pointer;
        }
        .candidate:hover {
            background-color: #f0f0f0;
        }
        /* Main content adjustments */
        #document-text {
            /* Adjustments if needed */
        }
        /* Titles */
        h2 {
            font-size: 1.5em;
        }
        /* Sidebar adjustments */
        #sidebar {
            overflow-y: auto;
            height: calc(100vh - 56px);
            position: sticky;
            top: 56px;
        }
        /* Fix for modal overflow */
        .modal-lg {
            max-width: 90%;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('index') }}">Geoparser Annotator</a>
        <div class="ms-auto">
            <a href="{{ url_for('download_annotations') }}" class="btn btn-outline-light me-2">Download</a>
            <button type="button" class="btn btn-outline-light" id="clear-cache-button">Clear</button>
        </div>
    </div>
</nav>

<!-- Main content -->
<div class="container-fluid">
    <div class="row">
        <!-- Left Sidebar (Documents) -->
        <div class="col-md-2 bg-light border-end" id="sidebar">
            <h2 class="mt-3">Documents</h2>
            <ul id="document-list" class="list-unstyled">
                {% for doc_item in documents %}
                <li class="mb-3">
                    <a href="{{ url_for('annotate', doc_index=loop.index0) }}" class="{% if loop.index0 == doc_index %}text-primary{% else %}text-dark{% endif %}" style="text-decoration: none;">
                        {{ doc_item['filename'] }}
                    </a>
                    <div class="progress">
                        <div id="progress-bar-{{ loop.index0 }}" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- Main Content -->
        <div class="col-md-10" id="main-content">
            <h2 class="mt-3">{{ doc.filename }}</h2>
            <div id="document-text" class="mt-4">
                {{ pre_annotated_text | safe }}
            </div>
        </div>
    </div>
</div>

<!-- Annotation Modal -->
<div class="modal fade" id="annotationModal" tabindex="-1" aria-labelledby="annotationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ toponym_text }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="row">
            <!-- Filter Panel -->
            <div class="col-md-4">
                <div id="modal-filter-panel">
                    <!-- Filters will be populated here -->
                </div>
            </div>
            <!-- Candidate List -->
            <div class="col-md-8">
                <div id="modal-candidate-list" style="max-height: 60vh; overflow-y: auto;">
                    <!-- Candidates will be populated here -->
                </div>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS and Dependencies -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Variables for the current document
        var docIndex = {{ doc_index }};
    
        // Initialize progress bars for all documents
        {% for doc_item in documents %}
            (function() {
                var index = {{ loop.index0 }};
                var progressBar = document.getElementById('progress-bar-' + index);
                var total = {{ doc_item['total_toponyms'] }};
                var annotated = {{ doc_item['annotated_toponyms'] }};
                var percentage = total > 0 ? (annotated / total) * 100 : 0;
                progressBar.style.width = percentage + '%';
                progressBar.setAttribute('aria-valuenow', percentage);
            })();
        {% endfor %}
    
        // Variables for the current document
        var totalToponyms = {{ doc['total_toponyms'] }};
        var annotatedToponyms = {{ doc['annotated_toponyms'] }};
        var progressBar = document.getElementById('progress-bar-' + docIndex);
    
        var toponyms = document.querySelectorAll('.toponym');
        toponyms.forEach(function(toponym) {
            toponym.addEventListener('click', function(event) {
                var start = parseInt(toponym.getAttribute('data-start'));
                var end = parseInt(toponym.getAttribute('data-end'));
                var text = toponym.textContent;
    
                fetch('{{ url_for("get_candidates") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        'doc_index': docIndex,
                        'start': start,
                        'end': end,
                        'text': text
                    })
                })
                .then(response => response.json())
                .then(data => {
                    showAnnotationModal(data.candidates, data.filter_attributes, data.existing_loc_id, function(selected_loc_id) {
                        fetch('{{ url_for("save_annotation") }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                'doc_index': docIndex,
                                'annotation': {
                                    'toponym': text,
                                    'start': start,
                                    'end': end,
                                    'loc_id': selected_loc_id
                                }
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.status === 'success') {
                                // Update the toponym's class immediately
                                if (!toponym.classList.contains('annotated')) {
                                    annotatedToponyms += 1;
                                    toponym.classList.add('annotated');
                                }
                                // Update progress bar for the current document
                                var progressPercentage = totalToponyms > 0 ? (annotatedToponyms / totalToponyms) * 100 : 0;
                                progressBar.style.width = progressPercentage + '%';
                                progressBar.setAttribute('aria-valuenow', progressPercentage);

                                // Update progress bar in the sidebar
                                var sidebarProgressBar = document.getElementById('progress-bar-' + docIndex);
                                sidebarProgressBar.style.width = progressPercentage + '%';
                                sidebarProgressBar.setAttribute('aria-valuenow', progressPercentage);
                            }
                        });
                    });
                });
            });
        });
    
        function showAnnotationModal(candidates, filterAttributes, existing_loc_id, callback) {
            var currentFilters = {};
            var filterInputs = {};
    
            var modal = new bootstrap.Modal(document.getElementById('annotationModal'));
            var modalCandidateList = document.getElementById('modal-candidate-list');
            var modalFilterPanel = document.getElementById('modal-filter-panel');
    
            // Clear previous content
            modalCandidateList.innerHTML = '';
            modalFilterPanel.innerHTML = '';
    
            // Prepare unique values for each filter attribute
            var attributeValues = {};
            filterAttributes.forEach(function(attribute) {
                attributeValues[attribute] = new Set();
            });
    
            candidates.forEach(function(candidate) {
                var attributes = candidate.attributes;
                filterAttributes.forEach(function(attribute) {
                    if (attributes[attribute]) {
                        attributeValues[attribute].add(attributes[attribute]);
                    }
                });
            });
    
            // Create drop-down filters
            filterAttributes.forEach(function(attribute) {
                var label = document.createElement('label');
                label.textContent = 'Filter by ' + attribute;
                label.classList.add('form-label');
    
                var select = document.createElement('select');
                select.dataset.attribute = attribute;
                select.classList.add('form-select', 'mb-3');
    
                // Add an empty option
                var emptyOption = document.createElement('option');
                emptyOption.value = '';
                emptyOption.textContent = 'All';
                select.appendChild(emptyOption);
    
                // Add options from attributeValues
                Array.from(attributeValues[attribute]).sort().forEach(function(value) {
                    var option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    select.appendChild(option);
                });
    
                modalFilterPanel.appendChild(label);
                modalFilterPanel.appendChild(select);
                filterInputs[attribute] = select;
            });
    
            // Add event listeners to filter inputs
            Object.keys(filterInputs).forEach(function(attribute) {
                filterInputs[attribute].addEventListener('change', function() {
                    var selectedValue = filterInputs[attribute].value.toLowerCase();
                    currentFilters[attribute] = selectedValue;
                    applyFilters();
                });
            });
    
            // Add 'None of the above' option
            var noneOption = document.createElement('div');
            noneOption.classList.add('candidate', 'p-2', 'border', 'mb-2');
            noneOption.textContent = 'None';
            noneOption.dataset.locId = null;
            noneOption.addEventListener('click', function() {
                modal.hide();
                callback(null);
            });
            modalCandidateList.appendChild(noneOption);
    
            // Append candidateDivs to candidateContainer
            candidates.forEach(function(candidate) {
                var candidateDiv = document.createElement('div');
                candidateDiv.classList.add('candidate', 'p-2', 'border', 'mb-2');
                candidateDiv.innerHTML = '<strong>' + candidate.description + '</strong>';
                candidateDiv.dataset.locId = candidate.loc_id;
                candidateDiv.dataset.attributes = JSON.stringify(candidate.attributes);
    
                // Highlight if this candidate is the existing selection
                if (existing_loc_id && candidate.loc_id == existing_loc_id) {
                    candidateDiv.classList.add('bg-primary', 'text-white');
                }
    
                candidateDiv.addEventListener('click', function() {
                    modal.hide();
                    callback(candidateDiv.dataset.locId);
                });
                modalCandidateList.appendChild(candidateDiv);
            });
    
            // Function to apply filters
            function applyFilters() {
                var candidatesDivs = modalCandidateList.querySelectorAll('.candidate');
                candidatesDivs.forEach(function(candidateDiv) {
                    if (!candidateDiv.dataset.attributes) {
                        candidateDiv.style.display = 'block';
                        return;
                    }
                    var attributes = JSON.parse(candidateDiv.dataset.attributes);
                    var showCandidate = true;
                    Object.keys(currentFilters).forEach(function(attribute) {
                        var filterValue = currentFilters[attribute];
                        var attributeValue = attributes[attribute] ? attributes[attribute].toString().toLowerCase() : '';
                        if (filterValue && attributeValue !== filterValue) {
                            showCandidate = false;
                        }
                    });
                    candidateDiv.style.display = showCandidate ? 'block' : 'none';
                });
            }
    
            // Show the modal
            modal.show();
        }
    
        // Clear Cache Confirmation Script
        document.getElementById('clear-cache-button').addEventListener('click', function() {
            if (confirm('Are you sure you want to clear the cache? All annotations will be deleted. Please download the annotations before clearing the cache.')) {
                fetch('{{ url_for("clear_cache") }}', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        alert('Cache cleared.');
    
                        // Reset the annotations on the page
                        // Remove 'annotated' class from all toponyms
                        var toponyms = document.querySelectorAll('.toponym');
                        toponyms.forEach(function(toponym) {
                            toponym.classList.remove('annotated');
                        });
    
                        // Reset annotatedToponyms count
                        annotatedToponyms = 0;
    
                        // Update progress bar for the current document
                        var progressPercentage = 0;
                        progressBar.style.width = progressPercentage + '%';
                        progressBar.setAttribute('aria-valuenow', progressPercentage);
    
                        // Update progress bar in the sidebar
                        var sidebarProgressBar = document.getElementById('progress-bar-' + docIndex);
                        sidebarProgressBar.style.width = progressPercentage + '%';
                        sidebarProgressBar.setAttribute('aria-valuenow', progressPercentage);
    
                        // Reset progress bars for all documents
                        {% for doc_item in documents %}
                            (function() {
                                var index = {{ loop.index0 }};
                                var progressBar = document.getElementById('progress-bar-' + index);
                                progressBar.style.width = '0%';
                                progressBar.setAttribute('aria-valuenow', 0);
                            })();
                        {% endfor %}
                    } else {
                        alert('Failed to clear cache.');
                    }
                });
            }
        });
    });
</script>
</body>
</html>
